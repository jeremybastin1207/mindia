# =============================================================================
# Mindia Environment Configuration
# =============================================================================
# Copy this file to .env and update the values for your environment
# Generate secure secrets with: openssl rand -hex 32

# =============================================================================
# Environment Configuration
# =============================================================================
# ENVIRONMENT: development, staging, or production
# Note: CORS_ORIGINS cannot be '*' in production for security
ENVIRONMENT=development
# APP_ENV=development  # Alternative variable name (also supported)

# =============================================================================
# Database Configuration
# =============================================================================
# Main PostgreSQL database (required)
DATABASE_URL=postgresql://user:password@your-neon-host.neon.tech/dbname?sslmode=require
# MEDIA_PROCESSOR_DATABASE_URL=postgresql://user:password@host/media_db?sslmode=require

# Database connection pool settings
DB_MAX_CONNECTIONS=20
DB_TIMEOUT_SECONDS=30

# Analytics Database Configuration (optional)
# By default, analytics use the main PostgreSQL database
# ANALYTICS_DB_TYPE=postgres
# ANALYTICS_DB_URL=postgresql://user:password@host/analytics_db

# =============================================================================
# Server Configuration
# =============================================================================
# Port for the HTTP server
# API server default: 3000
PORT=3000

# =============================================================================
# Authentication & Security
# =============================================================================
# JWT_SECRET: Secret key for JWT token signing (REQUIRED, min 32 characters)
# =============================================================================
# Authentication & Security
# =============================================================================
# MASTER_API_KEY: Master API key for authentication (REQUIRED)
# This key must be included in the Authorization header as: Bearer YOUR_KEY
# Generate with: openssl rand -hex 32
MASTER_API_KEY=your-secure-master-api-key-min-32-characters-long
# =============================================================================
# Comma-separated list of allowed origins
# Use * for development only (not allowed in production)
CORS_ORIGINS=*
# Production example:
# CORS_ORIGINS=https://example.com,https://app.example.com,https://admin.example.com

# =============================================================================
# Rate Limiting
# =============================================================================
# Global rate limit per IP (requests per minute)
HTTP_RATE_LIMIT_PER_MINUTE=100

# Per-tenant rate limit for authenticated users (optional, default: 200)
# HTTP_TENANT_RATE_LIMIT_PER_MINUTE=200

# =============================================================================
# Storage Configuration
# =============================================================================
# Storage backend: "s3" or "local" (default: s3)
# STORAGE_BACKEND=s3

# AWS S3 Configuration (required if using S3 storage)
S3_BUCKET=your-bucket-name
S3_REGION=us-east-1
AWS_ACCESS_KEY_ID=your-access-key-id
AWS_SECRET_ACCESS_KEY=your-secret-access-key

# S3-compatible storage (optional, for MinIO, DigitalOcean Spaces, etc.)
# S3_ENDPOINT=https://nyc3.digitaloceanspaces.com
# AWS_REGION=us-east-1

# Local Storage Configuration (alternative to S3)
# LOCAL_STORAGE_PATH=/var/lib/mindia/storage
# LOCAL_STORAGE_BASE_URL=http://localhost:3000/files

# CDN Configuration (optional, for Cloudflare or other CDN)
# When set, file downloads will redirect to CDN URLs for better performance
# CDN_BASE_URL=https://cdn.yourdomain.com
# CLOUDFRONT_URL=https://d1234567890.cloudfront.net

# =============================================================================
# Image Upload Configuration
# =============================================================================
MAX_FILE_SIZE_MB=10
ALLOWED_EXTENSIONS=jpg,jpeg,png,gif,webp,avif
ALLOWED_CONTENT_TYPES=image/jpeg,image/png,image/gif,image/webp,image/avif

# EXIF Metadata Removal (default: true)
# When enabled, removes EXIF metadata from uploaded images for privacy/security
# Set to false to preserve metadata
REMOVE_EXIF=true

# =============================================================================
# Video Upload & Processing Configuration
# =============================================================================
MAX_VIDEO_SIZE_MB=500
VIDEO_ALLOWED_EXTENSIONS=mp4,mov,avi,webm,mkv
VIDEO_ALLOWED_CONTENT_TYPES=video/mp4,video/quicktime,video/x-msvideo,video/webm,video/x-matroska

# FFmpeg Configuration
FFMPEG_PATH=ffmpeg
MAX_CONCURRENT_TRANSCODES=2

# HLS Streaming Configuration
HLS_SEGMENT_DURATION=6
HLS_VARIANTS=360p,480p,720p,1080p

# =============================================================================
# Document Upload Configuration
# =============================================================================
MAX_DOCUMENT_SIZE_MB=50
DOCUMENT_ALLOWED_EXTENSIONS=pdf
DOCUMENT_ALLOWED_CONTENT_TYPES=application/pdf

# =============================================================================
# Audio Upload Configuration
# =============================================================================
MAX_AUDIO_SIZE_MB=100
AUDIO_ALLOWED_EXTENSIONS=mp3,m4a,wav,flac,ogg
AUDIO_ALLOWED_CONTENT_TYPES=audio/mpeg,audio/mp4,audio/x-m4a,audio/wav,audio/flac,audio/ogg

# =============================================================================
# File Storing Behavior Configuration
# =============================================================================
# When AUTO_STORE_ENABLED is true (default), files uploaded with ?store=auto
# are stored permanently. When false, they are deleted after 24 hours.
# Users can override with ?store=1 (permanent) or ?store=0 (24h deletion)
AUTO_STORE_ENABLED=true

# URL Upload Allowlist (optional, SSRF prevention)
# Comma-separated list of allowed domains for URL uploads
# If set, only URLs from these domains are allowed
# URL_UPLOAD_ALLOWLIST=example.com,cdn.example.com,images.example.com

# =============================================================================
# Semantic Search (Anthropic/Claude or Voyage AI)
# When enabled, set at least one: ANTHROPIC_API_KEY or VOYAGE_API_KEY
# =============================================================================
SEMANTIC_SEARCH_ENABLED=false
ANTHROPIC_API_KEY=
ANTHROPIC_VISION_MODEL=claude-sonnet-4-20250514
ANTHROPIC_EMBEDDING_MODEL=embed-v3
# VOYAGE_API_KEY=
# VOYAGE_EMBEDDING_MODEL=voyage-3

# =============================================================================
# Content Moderation (AWS Rekognition)
# =============================================================================
# When true, queue content moderation for images/videos (default: false)
# CONTENT_MODERATION_ENABLED=false

# =============================================================================
# Virus Scanning (ClamAV)
# =============================================================================
# Enable virus scanning with ClamAV (default: false)
CLAMAV_ENABLED=false
CLAMAV_HOST=localhost
CLAMAV_PORT=3310

# Fail closed: If true, reject uploads when ClamAV is unavailable
# In production, this defaults to true for security
# CLAMAV_FAIL_CLOSED=true

# =============================================================================
# Task Queue Configuration (Media Processor)
# =============================================================================
# Number of concurrent task workers
TASK_QUEUE_MAX_WORKERS=4

# Polling interval in milliseconds
TASK_QUEUE_POLL_INTERVAL_MS=1000

# Rate limits (tasks per second)
TASK_QUEUE_VIDEO_RATE_LIMIT=2.0
TASK_QUEUE_EMBEDDING_RATE_LIMIT=5.0

# Task timeout and retry configuration
TASK_QUEUE_DEFAULT_TIMEOUT_SECONDS=3600
TASK_QUEUE_MAX_RETRIES=3

# Stale task reaper (for multi-instance: recovers tasks stuck in 'running' after instance crash)
# Interval in seconds between reaper runs. 0 = disabled
STALE_TASK_REAP_INTERVAL_SECS=60
# Grace period in seconds added to task timeout before reaping
STALE_TASK_GRACE_PERIOD_SECS=300

# =============================================================================
# Capacity Monitoring (Media Processor)
# =============================================================================
# Enable capacity monitoring (default: true for media processor)
CAPACITY_MONITOR_ENABLED=true
CAPACITY_MONITOR_INTERVAL_SECS=5

# Disk space requirements
MIN_DISK_FREE_GB=10
VIDEO_TRANSCODE_SPACE_MULTIPLIER=4.0

# Resource usage limits
MAX_MEMORY_USAGE_PERCENT=85.0
MAX_CPU_USAGE_PERCENT=90.0

# Behavior when limits are exceeded: "fail", "warn", or "log"
DISK_CHECK_BEHAVIOR=fail
MEMORY_CHECK_BEHAVIOR=warn
CPU_CHECK_BEHAVIOR=warn

# =============================================================================
# OpenTelemetry (Observability)
# =============================================================================
# Enable OpenTelemetry tracing and metrics (default: true)
OTEL_ENABLED=true

# OTLP endpoint for traces and metrics
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317

# Service identification
OTEL_SERVICE_NAME=mindia-api
# OTEL_SERVICE_VERSION=0.1.0  # Auto-detected from Cargo.toml if not set

# Protocol: "grpc" or "http/protobuf" (default: grpc)
OTEL_EXPORTER_OTLP_PROTOCOL=grpc

# Sampling configuration
# OTEL_SAMPLER: "always_on", "always_off", "traceidratio", "parentbased_always_on"
OTEL_SAMPLER=always_on
OTEL_SAMPLE_RATIO=1.0

# Metrics interval in seconds
OTEL_METRICS_INTERVAL_SECS=30

# =============================================================================
# Logging Configuration
# =============================================================================
# Rust logging configuration
# Levels: error, warn, info, debug, trace
RUST_LOG=mindia=info,tower_http=info

# For more verbose logging during development:
# RUST_LOG=mindia=debug,tower_http=debug,sqlx=debug

# For production (less verbose):
# RUST_LOG=mindia=info,tower_http=warn,sqlx=warn

# =============================================================================
# MCP Server (mindia-mcp binary, for Cursor / Claude Desktop)
# =============================================================================
# Used when running the Model Context Protocol server (cargo run -p mindia-mcp)
# MINDIA_API_KEY=your-api-key
# MINDIA_API_URL=http://localhost:3000
